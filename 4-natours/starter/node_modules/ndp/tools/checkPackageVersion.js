const semver = require('semver');
const sendRequest = require('./sendRequest');
const { error } = require('./logger');
const pkg = require('../package.json');

const checkPackageVersion = async () => {
  if (!pkg || !pkg.version) {
    error('无法获取当前版本');
    return;
  }
  let json = {};
  try {
    ({ json } = await sendRequest('https://registry.npmjs.org/ndp', {
      external: true,
    }));
  } catch (netError) {
    error('网络原因无法获取npm版本:https://registry.npmjs.org/ndp');
  }
  if (!json['dist-tags'] || !json['dist-tags'].latest) {
    error('无法获取npm最新版本');
    return;
  }
  if (json['dist-tags'] && json['dist-tags'].latest) {
    const latestVersion = json['dist-tags'].latest;
    const curVersion = pkg.version;
    if (semver.lt(curVersion, latestVersion)) {
      throw new Error(
        `当前版本${curVersion}小于最新版本${latestVersion},请更新包(杭研源下执行)`,
      );
    }
  }
};

module.exports = checkPackageVersion;
